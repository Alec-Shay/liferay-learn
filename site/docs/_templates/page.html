{%- extends "layout.html" %}

{% block content %}
<div class="container-fluid documentations">
    <div class="row">
        <div class="col-md-2 product-version-selector">
            <div class="info-bar">

            </div>

            <div class="doc-nav">
                {% block sidebar1 %}
                {{ toctree() }}

                {% endblock %}
            </div>
        </div>

        <div class="col-md-10 doc-body">
            <div class="col-md-12 general-info info-bar">
                {% include "breadcrumb.html" %}

                <div class="actions">
                    <svg>
                        <use xlink:href="#github"></use>
                    </svg>
                </div>
            </div>

            <div class="col-md-12 row">
                <div class="col-md-6 article-body offset-md-1">
                    {% block document %}
                    {{ body }}
                    {% endblock %}
                </div>

                <div class="col-md-2 offset-md-1">
                    <ul class="nav nav-stacked toc" id="articleTOC"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const headings = document.querySelectorAll('.article-body h2');

    let activeIndex;
    let targets = [];

    if (headings) {
        const articleTOC = document.getElementById('articleTOC');

        headings.forEach(
            heading => {
                const id = heading.children[0].hash.replace('#', '');

                if (articleTOC) {
                    articleTOC.innerHTML += `
                    <li class="nav-item">
                        <a class="nav-link" id="toc-${id}" href="#${id}">
                            ${heading.innerText}
                        </a>
                    </li>`;
                }

                targets.push({ id: id, isIntersecting: false });
            }
        );
    }

    const callback = entries => {
        entries.forEach(entry => {
            const index = targets.findIndex(target => target.id === entry.target.id);

            targets[index].isIntersecting = entry.isIntersecting;

            if (!targets[activeIndex] || !targets[activeIndex].isIntersecting) {
                setActiveIndex()
            }
        });

        toggleActiveClass(targets[activeIndex].id);
    };

    const observer = new IntersectionObserver(callback, { threshold: [0, 0.2, 0.4, 0.6, 0.8, 1] });

    const setActiveIndex = () => {
        activeIndex = targets.findIndex(target => target.isIntersecting === true);
    };

    const toggleActiveClass = id => {
        targets.forEach(target => {
            const node = document.getElementById(`toc-${target.id}`);

            if (node) {
                node.classList.remove('active');
            }
        });

        const activeNode = document.getElementById(`toc-${id}`);

        if (activeNode) {
            activeNode.classList.add('active');
        }
    }

    targets.forEach(target => {
        const node = document.getElementById(target.id);

        if (node) {
            observer.observe(node)
        }
    });
</script>
{% endblock %}